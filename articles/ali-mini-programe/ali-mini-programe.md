
# 支付宝小程序开发入门

## 一、移动端开发技术对比

大前端移动端开发一般分为Web，Native，Hybrid开发三大类

| 开发类别 | 优点 | 缺点 |
| --- | ---  | ---  | ---  |
| Web | 跨端开发，速度快，支持公司业务快速发展 | 体验较差 |
| Native | 更好的体验，性能，兼容性 | 功能迭代需要客户端发版 |
| Hybrid | 不需要客户端发版，同时接近原生体验，性能，兼容性 | 由于开发过程中需要编译预览，真机调试导致开发速度及体验不友好 |

众所周知，支付宝（微信）小程序的上架是不需要更新客户端app版本的，小程序提供了大量的原生基础组件（体验接近原生），页面样式，业务逻辑分别使用css,js开发，因此可以认为小程序技术属于Hybrid混合开发。接下来我们需要了解的是支付宝小程序Hybrid技术。

## 二、小程序技术架构

##### 1、包结构

我们先了解下小程序包的结构，小程序所有的代码经过ide编译后上传到cdn后包的结构如下：

```
├── index.html
├── index.js
├── index.worker.js
├── ...
```

- 客户端通过创建一个webview加载index.html，并由idnex.html加载index.js
- index.js负责小程序的视图展示
- index.worker.js负责小程序的业务逻辑
<br />

##### 2、双线程模型

由于web开发太开放了，可以直接操作DOM，跳转到其他web页面，为了安全与管控（包括请求必须是https协议且域名必须设置白名单），小程序采用了双线程模型，即：视图线程（Webview） 与 逻辑线程（worker）

<image src="./images/双线程模型.png" alt="双线程模型" width="60%">
<br />
<br />
2.1、所有的业务逻辑代码都是运行在worker线程中，开发者无法操作BOM与DOM对象，如果需要更新视图，只能通过setData方法更新数据，setData方法会调用worker对象的postMessage方法，将数据传递到视图层从而更新视图。
<br />
<br />
2.2、同理当页面触发某个事件，如tap事件类型，主线程webview向逻辑层发送postMessage消息并带上绑定tap事件的callback名称，逻辑层负责监听并执行定义的callback；
<br />
<br />
2.3、另外逻辑层调用的jsapi是通过AlipayJsBridge转发到原生来调用，通过定义jsapi的回调来监听原生执行的结果
<br />
<br />

##### 3、启动流程

早期的worker是基于webview内置的ServiceWorker机制创建的worker环境，逻辑层代码是在webview启动后执行的，这样就带来一个性能问题：串行；支付宝小程序后期引入了v8 worker引擎，解决了service worker的问题，webview加载与逻辑层并行执行，流程如下：

<image src="./images/v8小程序启动流程.png" alt="v8小程序启动流程" width="90%">
<!-- ![小程序双线程模型](./images/v8小程序启动流程.png) -->
<br />

## 三、小程序框架

##### 1、appx框架

```
├── af-appx.min.js
├── af-appx.worker.min.js
├── ...
```

- af-appx.min.js：也叫appx render框架，主要是用来渲染视图的，如：将小程序view标签转换为div；
- af-appx.worker.min.js：也叫appx worker框架，主要是建立worker与render的通信机制；提供构建小程序App，小程序页面Page，小程序自定义组件Component 全局方法...，提供小程序jsapi通过AlipayJsBridge调用原生能力

简要概括如下图：
<image src="./images/appx.png" alt="appx" width="80%">

##### 2、App与Page生命周期（路由机制）

<image src="./images/router.png" alt="路由机制" width="65%">

##### 3、组件生命周期

<image src="./images/comp.png" alt="组件生命周期" width="50%">

## 四、小程序测试

##### 1、新增自定义编译模式

小程序app.json配置默认启动页只有一个（默认设置为首页），如果你在开发过程中需要测试你新增的功能页面，你可以在小程序开发者工具ide中新增编译模式，设置启动页，还可以设置需要模拟的页面，全局参数，这样非常方便，而不需要去改动小程序的代码配置；如下图：

<image src="./images/compile-mode.png" alt="编译模式" width="50%">

##### 2、性能调试（入口在ide实验室）

- 在你完成功能页面开发后，即将上传小程序代码审核之前，你必须对你的页面进行性能调试，它可以帮助你发现代码错误，页面性能耗时等问题，并且建议你该怎么去做。

- 性能调试默认只针对启动页(即：app.json配置的第一个页面)，对新开发的功能页面做性能调试需要更改app.json配置。

##### 3、质量洞察与开发监控（入口在ide实验室）

作为小程序开发者，应该每天关心小程序的质量及线上问题监控状态，我们可以通过小程序开发者工具ide实验室（质量洞察，开发监控）发现存在的问题并在下一个版本迭代中解决出现的问题。

##### 4、web版打码工具（用于测试功能入口页面）

在实际的项目开发及测试过程你可能会遇到如下问题

- 多套服务端接口环境，如：我的团队需要对小程序上架版本进行测试与生产接口环境的流程该怎么做？

- 我在小程序中做了一个活动（后续我可能在另一个小程序中做了另一个活动），公司内部或外部会帮我推广该活动链接，我需要在最短的时间内给到，该怎么做？
- 三方小程序跳公司小程序，回跳三方小程序时传递了数据，我们该怎么去验证？
- 三方小程序集成了我们的插件页面，插件与小程序进行了事件通信，我们该如何去验证？

<image src="./images/qrcode-tool.png" alt="打码工具测试" width="80%">
